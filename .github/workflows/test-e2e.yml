name: Test E2E

on:
    push:
        branches: [dev, main]
        paths:
            - "Cargo.toml"
            - "Cargo.lock"
            - "src/**"
            - "crates/**"
            - "tests/**"
            - "scripts/**"
            - "scripts/ci/ensure_cc.sh"
            - ".github/workflows/test-e2e.yml"
    workflow_dispatch:

concurrency:
    group: test-e2e-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref_name || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: core.hooksPath
    GIT_CONFIG_VALUE_0: /dev/null
    CARGO_TERM_COLOR: always

jobs:
    integration-tests:
        name: Integration / E2E Tests
        runs-on: [self-hosted, Linux, X64, aws-india, blacksmith-2vcpu-ubuntu-2404, hetzner]
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
            - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
              with:
                  toolchain: 1.92.0
            - name: Ensure C toolchain for Rust builds
              run: ./scripts/ci/ensure_cc.sh
            - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v3
            - name: Runner preflight (compiler + disk)
              shell: bash
              run: |
                  set -euo pipefail
                  echo "Runner: ${RUNNER_NAME:-unknown} (${RUNNER_OS:-unknown}/${RUNNER_ARCH:-unknown})"
                  if ! command -v cc >/dev/null 2>&1; then
                    echo "::error::Missing 'cc' compiler on runner. Install build-essential (Debian/Ubuntu) or equivalent."
                    exit 1
                  fi
                  cc --version | head -n1
                  free_kb="$(df -Pk . | awk 'NR==2 {print $4}')"
                  min_kb=$((10 * 1024 * 1024))
                  if [ "${free_kb}" -lt "${min_kb}" ]; then
                    echo "::error::Insufficient disk space on runner (<10 GiB free)."
                    df -h .
                    exit 1
                  fi
            - name: Run integration / E2E tests
              run: cargo test --test agent_e2e --locked --verbose
